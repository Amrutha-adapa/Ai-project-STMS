<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Management System - Integrated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Home Page -->
    <div id="home-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
        <div class="text-center text-white px-4 max-w-4xl mx-auto">
            <h1 class="text-6xl md:text-8xl font-bold mb-8">üö¶ Smart Traffic Management System</h1>
            <h2 class="text-2xl md:text-3xl font-medium mb-8 text-blue-200">AI-powered traffic control for smarter cities</h2>
            <p class="text-lg md:text-xl mb-12 text-gray-200 max-w-3xl mx-auto leading-relaxed">
                Revolutionizing urban mobility through intelligent traffic analysis and adaptive signal control.
            </p>
            <button class="bg-white text-blue-600 font-bold py-5 px-10 rounded-full text-xl shadow-2xl transition-all duration-300 hover:transform hover:scale-110" onclick="showDashboard()">
                üöÄ Get Started
            </button>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard-page" class="hidden">
        <!-- Navigation Bar -->
        <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
            <div class="container mx-auto px-6">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <div class="text-3xl">üö¶</div>
                        <div>
                            <span class="text-2xl font-bold text-blue-600">STMS</span>
                            <div class="text-sm text-gray-500">Dashboard</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded-xl">
                        <button class="px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-600 hover:text-white transition-all" onclick="showTab('overview')">üìä Overview</button>
                        <button class="px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-600 hover:text-white transition-all" onclick="showTab('traffic-analysis')">üöó Traffic Analysis</button>
                        <button class="px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-600 hover:text-white transition-all" onclick="showTab('vehicle-detection')">üìπ Vehicle Detection</button>
                        <button class="px-6 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-600 hover:text-white transition-all" onclick="showTab('signal-simulation')">üö¶ Signal Simulation</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="pt-24 pb-8">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-12">
                        <h1 class="text-4xl font-bold text-gray-800 mb-4">Welcome to STMS Dashboard</h1>
                        <p class="text-xl text-gray-600">Select a tab from the navigation above to get started</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-xl">
                            <div class="text-4xl mb-4">üìä</div>
                            <h3 class="text-xl font-bold mb-2">Traffic Analysis</h3>
                            <p class="text-blue-100">Real-time traffic monitoring and analytics</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-xl">
                            <div class="text-4xl mb-4">üìπ</div>
                            <h3 class="text-xl font-bold mb-2">Vehicle Detection</h3>
                            <p class="text-green-100">AI-powered video analysis and detection</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-xl">
                            <div class="text-4xl mb-4">üö¶</div>
                            <h3 class="text-xl font-bold mb-2">Signal Simulation</h3>
                            <p class="text-purple-100">Virtual traffic light control system</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-xl">
                            <div class="text-4xl mb-4">üìà</div>
                            <h3 class="text-xl font-bold mb-2">Performance</h3>
                            <p class="text-orange-100">System metrics and optimization</p>
                        </div>
                    </div>

                    <!-- Backend Status -->
                    <div class="mt-12 bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üîå Backend Connection Status</h2>
                        <div class="flex items-center space-x-4">
                            <div id="backend-status" class="w-4 h-4 rounded-full bg-gray-400"></div>
                            <span id="backend-status-text" class="text-gray-600">Checking connection...</span>
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            <p>Backend URL: <span id="backend-url" class="font-mono">http://127.0.0.1:5000</span></p>
                            <p>Mode: <span id="backend-mode" class="font-mono">Unknown</span></p>
                        </div>
                        <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg" onclick="testBackend()">Test Connection</button>
                    </div>
                </div>
            </div>

            <!-- Traffic Analysis Tab -->
            <div id="traffic-analysis" class="tab-content hidden">
                <div class="container mx-auto px-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">üöó Traffic Analysis</h2>
                        
                        <!-- Live Data Display -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                            <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border-2 border-blue-200">
                                <div class="text-4xl font-bold text-blue-600 mb-2" id="countA">0</div>
                                <div class="text-lg text-blue-700 font-medium">Lane A</div>
                                <div class="text-sm text-blue-600" id="signalA">Red</div>
                            </div>
                            <div class="text-center p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border-2 border-green-200">
                                <div class="text-4xl font-bold text-green-600 mb-2" id="countB">0</div>
                                <div class="text-lg text-green-700 font-medium">Lane B</div>
                                <div class="text-sm text-green-600" id="signalB">Red</div>
                            </div>
                            <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border-2 border-purple-200">
                                <div class="text-4xl font-bold text-purple-600 mb-2" id="countC">0</div>
                                <div class="text-lg text-purple-700 font-medium">Lane C</div>
                                <div class="text-sm text-purple-600" id="signalC">Red</div>
                            </div>
                            <div class="text-center p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl border-2 border-orange-200">
                                <div class="text-4xl font-bold text-orange-600 mb-2" id="countD">0</div>
                                <div class="text-lg text-orange-700 font-medium">Lane D</div>
                                <div class="text-sm text-orange-600" id="signalD">Red</div>
                            </div>
                        </div>

                        <!-- Traffic Chart -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Traffic Density Chart</h3>
                            <div class="h-80">
                                <canvas id="trafficChart"></canvas>
                            </div>
                        </div>

                        <!-- Control Buttons -->
                        <div class="mt-6 flex flex-wrap gap-4">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition duration-200" onclick="refreshTrafficData()">üîÑ Refresh Data</button>
                            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition duration-200" onclick="startLiveUpdates()">‚ñ∂Ô∏è Start Live Updates</button>
                            <button class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition duration-200" onclick="stopLiveUpdates()">‚èπÔ∏è Stop Live Updates</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vehicle Detection Tab -->
            <div id="vehicle-detection" class="tab-content hidden">
                <div class="container mx-auto px-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">üìπ Vehicle Detection</h2>
                        
                        <!-- Video Upload Section -->
                        <div class="max-w-4xl mx-auto mb-8">
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all duration-300" onclick="document.getElementById('videoInput').click()">
                                <div class="text-gray-500">
                                    <svg class="mx-auto h-20 w-20 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-2xl font-medium mb-2">Click to upload traffic video</p>
                                    <p class="text-gray-400">or drag and drop</p>
                                    <p class="text-sm text-gray-400 mt-2">Supported: MP4, AVI, MOV, MKV</p>
                                </div>
                            </div>
                            <input type="file" id="videoInput" accept="video/*" class="hidden" onchange="handleVideoUpload(event)">
                            
                            <div class="mt-6 flex gap-4">
                                <button id="uploadBtn" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium py-4 px-6 rounded-xl transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-lg" onclick="uploadVideo()" disabled>
                                    üì§ Upload Video
                                </button>
                                <button id="processBtn" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium py-4 px-6 rounded-xl transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-lg" onclick="processVideo()" disabled>
                                    üîÑ Process Video
                                </button>
                            </div>
                        </div>

                        <!-- Video Display Section -->
                        <div id="video-display-section" class="hidden">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">üé• Processed Video Results</h3>
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div id="video-results" class="text-center">
                                    <!-- Results will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signal Simulation Tab -->
            <div id="signal-simulation" class="tab-content hidden">
                <div class="container mx-auto px-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">üö¶ Signal Simulation</h2>
                        
                        <!-- Traffic Lights Display -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-8">
                            <div class="text-center">
                                <div class="mb-4">
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-red-500 shadow-lg" id="lightA-red"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightA-yellow"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightA-green"></div>
                                </div>
                                <div class="text-lg font-medium text-gray-700">Lane A</div>
                                <div class="text-sm text-gray-500" id="timingA">15s</div>
                            </div>
                            
                            <div class="text-center">
                                <div class="mb-4">
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-red-500 shadow-lg" id="lightB-red"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightB-yellow"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightB-green"></div>
                                </div>
                                <div class="text-lg font-medium text-gray-700">Lane B</div>
                                <div class="text-sm text-gray-500" id="timingB">15s</div>
                            </div>
                            
                            <div class="text-center">
                                <div class="mb-4">
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-red-500 shadow-lg" id="lightC-red"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightC-yellow"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightC-green"></div>
                                </div>
                                <div class="text-lg font-medium text-gray-700">Lane C</div>
                                <div class="text-sm text-gray-500" id="timingC">15s</div>
                            </div>
                            
                            <div class="text-center">
                                <div class="mb-4">
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-red-500 shadow-lg" id="lightD-red"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightD-yellow"></div>
                                    <div class="w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400" id="lightD-green"></div>
                                </div>
                                <div class="text-lg font-medium text-gray-700">Lane D</div>
                                <div class="text-sm text-gray-500" id="timingD">15s</div>
                            </div>
                        </div>
                        
                        <!-- Manual Control Buttons -->
                        <div class="text-center">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg mr-3" onclick="setLaneGreen('A')">Set Lane A Green</button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg mr-3" onclick="setLaneGreen('B')">Set Lane B Green</button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg mr-3" onclick="setLaneGreen('C')">Set Lane C Green</button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg" onclick="setLaneGreen('D')">Set Lane D Green</button>
                        </div>

                        <!-- Auto Mode Toggle -->
                        <div class="mt-8 text-center">
                            <button id="autoModeBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg" onclick="toggleAutoMode()">üö¶ Enable Auto Mode</button>
                            <p class="text-sm text-gray-600 mt-2">Auto mode will cycle signals based on traffic density</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://127.0.0.1:5000';
        
        // Global variables
        let trafficChart;
        let liveUpdateInterval;
        let autoModeInterval;
        let currentVideoFile = null;
        let isAutoMode = false;

        // Page Navigation
        function showDashboard() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('dashboard-page').classList.remove('hidden');
            showTab('overview');
            initializeDashboard();
        }

        // Tab Navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            
            // Initialize specific tab content
            if (tabId === 'traffic-analysis') {
                initializeTrafficChart();
            }
        }

        // Initialize Dashboard
        function initializeDashboard() {
            checkBackendConnection();
            refreshTrafficData();
        }

        // Check Backend Connection
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('backend-status').className = 'w-4 h-4 rounded-full bg-green-500';
                    document.getElementById('backend-status-text').textContent = 'Connected';
                    document.getElementById('backend-mode').textContent = data.mode;
                } else {
                    throw new Error('Backend not healthy');
                }
            } catch (error) {
                document.getElementById('backend-status').className = 'w-4 h-4 rounded-full bg-red-500';
                document.getElementById('backend-status-text').textContent = 'Disconnected';
                document.getElementById('backend-mode').textContent = 'Unknown';
                console.error('Backend connection failed:', error);
            }
        }

        // Test Backend Connection
        async function testBackend() {
            const statusDiv = document.getElementById('status') || document.getElementById('backend-status-text');
            statusDiv.textContent = 'Testing connection...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.textContent = 'Connected';
                    checkBackendConnection();
                } else {
                    statusDiv.textContent = 'Backend not healthy';
                }
            } catch (error) {
                statusDiv.textContent = 'Connection failed';
                console.error('Error:', error);
            }
        }

        // Refresh Traffic Data
        async function refreshTrafficData() {
            try {
                const response = await fetch(`${BACKEND_URL}/traffic_data`);
                const data = await response.json();
                
                if (data.success) {
                    updateTrafficDisplay(data.data);
                    updateTrafficLights(data.data);
                }
            } catch (error) {
                console.error('Failed to fetch traffic data:', error);
            }
        }

        // Update Traffic Display
        function updateTrafficDisplay(trafficData) {
            document.getElementById('countA').textContent = trafficData.laneA.count;
            document.getElementById('countB').textContent = trafficData.laneB.count;
            document.getElementById('countC').textContent = trafficData.laneC.count;
            document.getElementById('countD').textContent = trafficData.laneD.count;

            document.getElementById('signalA').textContent = trafficData.laneA.signal;
            document.getElementById('signalB').textContent = trafficData.laneB.signal;
            document.getElementById('signalC').textContent = trafficData.laneC.signal;
            document.getElementById('signalD').textContent = trafficData.laneD.signal;

            if (trafficChart) {
                trafficChart.data.datasets[0].data = [
                    trafficData.laneA.count,
                    trafficData.laneB.count,
                    trafficData.laneC.count,
                    trafficData.laneD.count
                ];
                trafficChart.update();
            }
        }

        // Update Traffic Lights
        function updateTrafficLights(trafficData) {
            const lanes = ['A', 'B', 'C', 'D'];
            
            lanes.forEach(lane => {
                const laneData = trafficData[`lane${lane}`];
                document.getElementById(`timing${lane}`).textContent = `${laneData.time}s`;
                
                if (laneData.signal === 'Green') {
                    document.getElementById(`light${lane}-green`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-green-500 shadow-lg';
                    document.getElementById(`light${lane}-red`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                    document.getElementById(`light${lane}-yellow`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                } else if (laneData.signal === 'Yellow') {
                    document.getElementById(`light${lane}-yellow`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-yellow-500 shadow-lg';
                    document.getElementById(`light${lane}-red`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                    document.getElementById(`light${lane}-green`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                } else {
                    document.getElementById(`light${lane}-red`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-red-500 shadow-lg';
                    document.getElementById(`light${lane}-yellow`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                    document.getElementById(`light${lane}-green`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                }
            });
        }

        // Initialize Traffic Chart
        function initializeTrafficChart() {
            const ctx = document.getElementById('trafficChart');
            if (!ctx) return;

            trafficChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Lane A', 'Lane B', 'Lane C', 'Lane D'],
                    datasets: [{
                        label: 'Vehicle Count',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(147, 51, 234, 0.8)',
                            'rgba(249, 115, 22, 0.8)'
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(34, 197, 94, 1)',
                            'rgba(147, 51, 234, 1)',
                            'rgba(249, 115, 22, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.1)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Start Live Updates
        function startLiveUpdates() {
            if (liveUpdateInterval) clearInterval(liveUpdateInterval);
            liveUpdateInterval = setInterval(refreshTrafficData, 5000);
            console.log('Live updates started');
        }

        // Stop Live Updates
        function stopLiveUpdates() {
            if (liveUpdateInterval) {
                clearInterval(liveUpdateInterval);
                liveUpdateInterval = null;
                console.log('Live updates stopped');
            }
        }

        // Toggle Auto Mode
        function toggleAutoMode() {
            isAutoMode = !isAutoMode;
            const btn = document.getElementById('autoModeBtn');
            
            if (isAutoMode) {
                btn.textContent = 'üö¶ Disable Auto Mode';
                btn.className = 'bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg';
                startAutoMode();
            } else {
                btn.textContent = 'üö¶ Enable Auto Mode';
                btn.className = 'bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg';
                stopAutoMode();
            }
        }

        // Start Auto Mode
        function startAutoMode() {
            if (autoModeInterval) clearInterval(autoModeInterval);
            
            autoModeInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/simulate_traffic`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lane: ['A', 'B', 'C', 'D'][Math.floor(Math.random() * 4)],
                            count: Math.floor(Math.random() * 20) + 5
                        })
                    });
                    
                    if (response.ok) {
                        refreshTrafficData();
                    }
                } catch (error) {
                    console.error('Auto mode error:', error);
                }
            }, 10000);
        }

        // Stop Auto Mode
        function stopAutoMode() {
            if (autoModeInterval) {
                clearInterval(autoModeInterval);
                autoModeInterval = null;
            }
        }

        // Video Upload Functions
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('video/')) {
                currentVideoFile = file;
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('processBtn').disabled = false;
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'mt-4 p-4 bg-blue-50 rounded-lg';
                fileInfo.innerHTML = `
                    <p class="text-blue-800"><strong>Selected:</strong> ${file.name}</p>
                    <p class="text-blue-600 text-sm">Size: ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                    <p class="text-blue-600 text-sm">Type: ${file.type}</p>
                `;
                
                const existingInfo = document.querySelector('.bg-blue-50');
                if (existingInfo) existingInfo.remove();
                
                document.getElementById('uploadBtn').parentNode.appendChild(fileInfo);
            }
        }

        // Upload Video to Backend
        async function uploadVideo() {
            if (!currentVideoFile) {
                alert('Please select a video file first');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('video', currentVideoFile);

                const response = await fetch(`${BACKEND_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ ${result.message}\nFilename: ${result.filename}`);
                    // Enable process button after successful upload
                    document.getElementById('processBtn').disabled = false;
                } else {
                    throw new Error(result.message || 'Upload failed');
                }

            } catch (error) {
                console.error('Upload error:', error);
                alert(`‚ùå Error uploading video: ${error.message}`);
            }
        }

        // Process Video
        async function processVideo() {
            if (!currentVideoFile) {
                alert('Please select a video file first');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('video', currentVideoFile);

                const response = await fetch(`${BACKEND_URL}/process_video`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    updateTrafficDisplay(result.signals);
                    updateTrafficLights(result.signals);
                    showVideoResults(result);
                    refreshTrafficData();
                    alert(`‚úÖ ${result.message}`);
                } else {
                    throw new Error(result.message || 'Video processing failed');
                }

            } catch (error) {
                console.error('Video processing error:', error);
                alert(`‚ùå Error processing video: ${error.message}`);
            }
        }

        // Show Video Results
        function showVideoResults(result) {
            const resultsDiv = document.getElementById('video-results');
            resultsDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <h4 class="text-xl font-bold text-green-600 mb-2">Video Processed Successfully!</h4>
                    <p class="text-gray-600 mb-4">${result.message}</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${result.vehicle_counts.laneA}</div>
                            <div class="text-sm text-blue-600">Lane A</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${result.vehicle_counts.laneB}</div>
                            <div class="text-sm text-green-600">Lane B</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600">${result.vehicle_counts.laneC}</div>
                            <div class="text-sm text-purple-600">Lane C</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600">${result.vehicle_counts.laneD}</div>
                            <div class="text-sm text-orange-600">Lane D</div>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-500">Traffic signals have been updated based on vehicle density</p>
                </div>
            `;
            
            document.getElementById('video-display-section').classList.remove('hidden');
        }

        // Traffic Light Control
        async function setLaneGreen(lane) {
            try {
                ['A', 'B', 'C', 'D'].forEach(l => {
                    document.getElementById(`light${l}-red`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                    document.getElementById(`light${l}-yellow`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                    document.getElementById(`light${l}-green`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                });
                
                document.getElementById(`light${lane}-green`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-green-500 shadow-lg';
                
                const response = await fetch(`${BACKEND_URL}/simulate_traffic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lane: lane,
                        count: Math.floor(Math.random() * 15) + 10
                    })
                });
                
                if (response.ok) {
                    refreshTrafficData();
                }
            } catch (error) {
                console.error('Error setting lane green:', error);
            }
        }

        // Initialize chart when traffic analysis tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize traffic lights to red
            ['A', 'B', 'C', 'D'].forEach(lane => {
                document.getElementById(`light${lane}-red`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-red-500 shadow-lg';
                document.getElementById(`light${lane}-yellow`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
                document.getElementById(`light${lane}-green`).className = 'w-16 h-16 rounded-full mx-auto mb-3 bg-gray-400';
            });
        });
    </script>
</body>
</html>
